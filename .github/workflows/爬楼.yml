name: çˆ¬æ¥¼ä»»åŠ¡

on:
  schedule:
    - cron: '10 4 * * 1-5'  # UTCæ—¶é—´4:10ï¼Œå³åŒ—äº¬æ—¶é—´12:10
  workflow_dispatch:

jobs:
  climbing-task:
    runs-on: ubuntu-latest
    env:
      API_URL: https://carbon-account-server.carbonstop.net/task/completeTimeTripTask
      REQUEST_BODY_1: '{"value":"1","sceneCode":"MRCJ0021","signMessage":"3df1c430e4c80f62f9faa809bf380c06"}'
      REQUEST_BODY_24: '{"sceneCode":"MRCJ0021","value":"24","signMessage":"fcff47b42c5a6782387ea2cf3d4e33d6"}'
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        
      - name: å®‰è£…å¿…è¦å·¥å…·
        run: sudo apt-get -qq install jq
        
      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶
        run: |
          if [ ! -f "user-configs.json" ]; then
            echo "::error::é…ç½®æ–‡ä»¶ user-configs.json ä¸å­˜åœ¨ï¼"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶ user-configs.json"
            echo "ğŸ“‹ ç”¨æˆ·åˆ—è¡¨:"
            jq -r 'keys[]' user-configs.json
          fi
        
      - name: æ‰§è¡Œçˆ¬æ¥¼ä»»åŠ¡
        run: |
          #!/bin/bash
          function execute_climbing_round() {
            local round=$1
            
            # ç¬¬ä¸€æ­¥ï¼šæäº¤å€¼ä¸º1çš„è¯·æ±‚
            echo "ğŸƒ ç¬¬${round}è½®çˆ¬æ¥¼ç¬¬ä¸€æ­¥å¼€å§‹ (æäº¤å€¼:1)"
            while IFS='=' read -r user token; do
              echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
              echo "ğŸ”„ å¤„ç†ç”¨æˆ·: $user"
              
              # æ£€æŸ¥tokenæ˜¯å¦ä¸ºç©º
              if [ -z "$token" ] || [ "$token" = "null" ]; then
                echo "âš ï¸ è­¦å‘Š: $user çš„appTokenä¸ºç©ºæˆ–æœªè®¾ç½®"
                continue
              fi
              
              # æ‰§è¡Œçˆ¬æ¥¼è¯·æ±‚ (å€¼:1)
              echo "ğŸ” è¯·æ±‚è¯¦æƒ…:"
              echo "  URL: $API_URL"
              echo "  Token: $token"
              echo "  Body: $REQUEST_BODY_1"
              
              curl -s -w "\n" -X POST \
                -H "Content-Type: application/json" \
                -H "Authorization: $token" \
                -d "$REQUEST_BODY_1" \
                $API_URL
                
              echo  # æ·»åŠ ç©ºè¡Œ
              sleep 1  # ç”¨æˆ·é—´çŸ­æš‚é—´éš”
            done < <(jq -r 'to_entries[] | "\(.key)=\(.value.appToken)"' user-configs.json)
            echo "âœ… ç¬¬${round}è½®çˆ¬æ¥¼ç¬¬ä¸€æ­¥å®Œæˆ"
            
            # ç­‰å¾…5åˆ†é’Ÿ
            echo -e "\nğŸ•’ ç­‰å¾…5åˆ†é’Ÿè¿›è¡Œç¬¬${round}è½®ç¬¬äºŒæ­¥...\n"
            sleep 300
            
            # ç¬¬äºŒæ­¥ï¼šæäº¤å€¼ä¸º24çš„è¯·æ±‚
            echo "ğŸƒ ç¬¬${round}è½®çˆ¬æ¥¼ç¬¬äºŒæ­¥å¼€å§‹ (æäº¤å€¼:24)"
            while IFS='=' read -r user token; do
              echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
              echo "ğŸ”„ å¤„ç†ç”¨æˆ·: $user"
              
              # æ£€æŸ¥tokenæ˜¯å¦ä¸ºç©º
              if [ -z "$token" ] || [ "$token" = "null" ]; then
                echo "âš ï¸ è­¦å‘Š: $user çš„appTokenä¸ºç©ºæˆ–æœªè®¾ç½®"
                continue
              fi
              
              # æ‰§è¡Œçˆ¬æ¥¼è¯·æ±‚ (å€¼:24)
              echo "ğŸ” è¯·æ±‚è¯¦æƒ…:"
              echo "  URL: $API_URL"
              echo "  Token: $token"
              echo "  Body: $REQUEST_BODY_24"
              
              curl -s -w "\n" -X POST \
                -H "Content-Type: application/json" \
                -H "Authorization: $token" \
                -d "$REQUEST_BODY_24" \
                $API_URL
                
              echo  # æ·»åŠ ç©ºè¡Œ
              sleep 1  # ç”¨æˆ·é—´çŸ­æš‚é—´éš”
            done < <(jq -r 'to_entries[] | "\(.key)=\(.value.appToken)"' user-configs.json)
            echo "âœ… ç¬¬${round}è½®çˆ¬æ¥¼ç¬¬äºŒæ­¥å®Œæˆ"
          }
          
          # æ‰§è¡Œ3è½®çˆ¬æ¥¼ä»»åŠ¡
          for i in {1..3}; do
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œç¬¬${i}è½®çˆ¬æ¥¼ä»»åŠ¡"
            execute_climbing_round $i
            
            # å¦‚æœä¸æ˜¯æœ€åä¸€è½®ï¼Œç­‰å¾…20ç§’è¿›å…¥ä¸‹ä¸€è½®
            if [ $i -lt 3 ]; then
              echo -e "\nğŸ•’ ç­‰å¾…20ç§’è¿›å…¥ä¸‹ä¸€è½®çˆ¬æ¥¼...\n"
              sleep 20
            fi
          done
          
          echo "ğŸ æ‰€æœ‰çˆ¬æ¥¼ä»»åŠ¡å·²å®Œæˆ"
