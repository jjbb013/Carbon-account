name: ç­”é¢˜ä»»åŠ¡

on:
  schedule:
    - cron: '16 4 * * *' # UTCæ—¶é—´4:16ï¼Œå³åŒ—äº¬æ—¶é—´12:16
  workflow_dispatch:

jobs:
  execute-questions:
    runs-on: ubuntu-latest
    env:
      # è¯·æ±‚è®¾ç½®
      API_URL: https://carbon-account-server.carbonstop.net/question/submit
      REQUEST_BODY: '[{"answerA":"åˆç†ä¿è¯å°±æ˜¯ä¿è¯æ•°æ®æ˜¯ç»å¯¹å‡†ç¡®çš„  ","correctAnswer":"A","updateTime":"2022-07-15 18:59:16","answerB":"åˆç†ä¿è¯è¯´æ˜æ•°æ®æ˜¯ç›¸å¯¹å‡†ç¡®å’Œå¯ä»¥ä¿¡èµ–çš„","questionTitle":"å…³äºä¿è¯ç­‰çº§è¯´æ³•ä¸æ­£ç¡®çš„æ˜¯","answerC":"ä»»ä½•ç»„ç»‡çš„æ¸©å®¤æ°”ä½“æ ¸æŸ¥éƒ½å¯è¦æ±‚ä½œæœ‰é™ä¿è¯çš„è¯„å®¡","answerNum":0,"questionLabels":["001"],"delFlag":0,"answerD":"æœ‰é™ä¿è¯å¯¹æ•°æ®çš„å®Œæ•´æ€§åšæœ‰é™åº¦çš„è¯„å®¡  ","id":351,"delFlag_name":"æ­£å¸¸","questionType_name":"å•é€‰","createBy":0,"questionType":1,"answerE":null,"updateBy":0,"questionType_name_format":"å•é€‰","answerF":null,"createTime":"2022-07-15 18:54:26","answerG":null},{"answerA":"å›½é™…æ’æ”¾å› å­","correctAnswer":"B","updateTime":"2022-07-15 19:04:26","answerB":"ç›¸åŒå·¥è‰º\/è®¾å¤‡çš„ç»éªŒç³»æ•°è·å¾—çš„æ’æ”¾å› å­","questionTitle":"åœ¨æ ¸æŸ¥è¿‡ç¨‹ä¸­å¸¸ç”¨æ’æ”¾å› å­æ³•æ¥è®¡ç®—æ¸©å®¤æ°”ä½“æ’æ”¾é‡ï¼Œä»¥ä¸‹4ç±»æ’æ”¾å› å­ä¸­ï¼Œæ•°æ®è´¨é‡è¾ƒé«˜çš„æ˜¯ï¼ˆ ï¼‰","answerC":"åŒºåŸŸæ’æ”¾å› å­","answerNum":0,"questionLabels":["001"],"delFlag":0,"answerD":"è®¾å¤‡åˆ¶é€ å•†æä¾›çš„ç³»æ•°è·å¾—çš„æ’æ”¾å› å­","id":316,"delFlag_name":"æ­£å¸¸","questionType_name":"å•é€‰","createBy":0,"questionType":1,"answerE":null,"updateBy":0,"questionType_name_format":"å•é€‰","answerF":null,"createTime":"2022-07-15 18:54:26","answerG":null},{"answerA":"å®¶ç”¨å†°ç®±è¿è¡Œ3å¤©","correctAnswer":"C","updateTime":"2022-07-15 18:54:26","answerB":"æ™®é€šç”µè§†æœºæŒç»­å¼€1å¤©","questionTitle":"1åº¦ç”µç›¸å½“äº(   ):","answerC":"25ç“¦çš„ç¯æ³¡èƒ½è¿ç»­ç‚¹äº®40å°æ—¶","answerNum":0,"questionLabels":["001"],"delFlag":0,"answerD":"å°†20å…¬æ–¤çš„æ°´çƒ§å¼€","id":406,"delFlag_name":"æ­£å¸¸","questionType_name":"å•é€‰","createBy":0,"questionType":1,"answerE":null,"updateBy":0,"questionType_name_format":"å•é€‰","answerF":null,"createTime":"2022-07-15 18:54:26","answerG":null},{"answerA":"èµ„æº","correctAnswer":"A","updateTime":"2022-07-15 18:54:26","answerB":"æ±¡æŸ“","questionTitle":"é€šå¸¸è®¤ä¸ºåƒåœ¾æ˜¯æ”¾é”™äº†åœ°æ–¹çš„__________ã€‚","answerC":"åºŸç‰©","answerNum":0,"questionLabels":["001"],"delFlag":0,"answerD":null,"id":107,"delFlag_name":"æ­£å¸¸","questionType_name":"å•é€‰","createBy":0,"questionType":1,"answerE":null,"updateBy":0,"questionType_name_format":"å•é€‰","answerF":null,"createTime":"2022-07-15 18:54:26","answerG":null},{"answerA":"è§£å†³å¥½ç»æµå¢é•¿â€”â€”èƒ½æºæ¶ˆè´¹â€”â€”GHGå‡æ’çš„ä¸‰è§’å…³ç³»","correctAnswer":"A,B,C","updateTime":"2022-07-15 19:02:41","answerB":"è°ƒæ•´èƒ½æºæ¶ˆè´¹ç»“æ„çš„åŒæ—¶ä¿éšœèƒ½æºä¾›åº”","questionTitle":"å®ç°â€30Â·60â€ç›®æ ‡éœ€è¦ç›´é¢çš„ä¸‰å¤§éš¾é¢˜","answerC":"ç¯å¢ƒæ²»ç†ä¸å‡æ’ä¸èƒ½ç»™å¤§ä¼—å¸¦æ¥æ²‰é‡çš„ç»æµè´Ÿæ‹…","answerNum":0,"questionLabels":["001"],"delFlag":0,"answerD":null,"id":550,"delFlag_name":"æ­£å¸¸","questionType_name":"å¤šé€‰","createBy":0,"questionType":2,"answerE":null,"updateBy":0,"questionType_name_format":"å¤šé€‰","answerF":null,"createTime":"2022-07-15 18:54:26","answerG":null}]'
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        
      - name: è¯»å–ç”¨æˆ·é…ç½®
        run: |
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "user-configs.json" ]; then
            echo "::error::é…ç½®æ–‡ä»¶ user-configs.json ä¸å­˜åœ¨ï¼"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶ user-configs.json"
            echo "ğŸ“‹ ç”¨æˆ·åˆ—è¡¨:"
            jq -r 'keys[]' user-configs.json
          fi
        
      - name: æ‰§è¡Œç­”é¢˜ä»»åŠ¡
        run: |
          #!/bin/bash
          function execute_questions_for_user() {
            local user="$1"
            local token="$2"
            
            echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
            echo "ğŸ”„ å¤„ç†ç”¨æˆ·: $user"
            
            # æ£€æŸ¥tokenæ˜¯å¦ä¸ºç©º
            if [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "âš ï¸ è­¦å‘Š: $user çš„appTokenä¸ºç©ºæˆ–æœªè®¾ç½®"
              return
            fi
            
            # æ‰§è¡Œç­”é¢˜è¯·æ±‚
            echo "ğŸ” è¯·æ±‚è¯¦æƒ…:"
            #echo "  URL: $API_URL"
            #echo "  Token: $token"
            #echo "  Body: $REQUEST_BODY"
            
            # ä½¿ç”¨ -w æ·»åŠ å“åº”åæ¢è¡Œ
            curl -s -w "\n" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: $token" \
              -d "$REQUEST_BODY" \
              $API_URL
            
            # å†æ·»åŠ ä¸€ä¸ªç©ºè¡Œä½¿æ ¼å¼æ›´æ¸…æ™°
            echo
          }
          
          # ç¬¬ä¸€è½®ç­”é¢˜
          echo "â¡ï¸ ç¬¬1è½®ç­”é¢˜å¼€å§‹"
          while IFS='=' read -r user token; do
            execute_questions_for_user "$user" "$token"
          done < <(jq -r 'to_entries[] | "\(.key)=\(.value.appToken)"' user-configs.json)
          
          # ç­‰å¾…10ç§’åè¿›è¡Œç¬¬äºŒè½®
          echo -e "\nğŸ•’ ç­‰å¾…10ç§’åè¿›è¡Œç¬¬äºŒè½®ç­”é¢˜...\n"
          sleep 10
          
          # ç¬¬äºŒè½®ç­”é¢˜
          echo "â¡ï¸ ç¬¬2è½®ç­”é¢˜å¼€å§‹"
          while IFS='=' read -r user token; do
            execute_questions_for_user "$user" "$token"
          done < <(jq -r 'to_entries[] | "\(.key)=\(.value.appToken)"' user-configs.json)
          
          # ä»»åŠ¡ç»“æŸ
          echo -e "\nğŸ ç­”é¢˜ä»»åŠ¡å·²å®Œæˆ"
