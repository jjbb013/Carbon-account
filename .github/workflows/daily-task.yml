name: ç¢³è´¦æˆ·ç­¾åˆ°

on:
  schedule:
    - cron: '1 1 * * *'  # UTCæ—¶é—´1:01ï¼Œå³åŒ—äº¬æ—¶é—´9:01æ‰§è¡Œ
  workflow_dispatch:

jobs:
  carbon-signin:
    runs-on: ubuntu-latest
    env:
      API_URL: https://carbon-account-server.carbonstop.net/task/complete
      REQUEST_BODY: '{"value":1,"sceneCode":"MRCJ0002","signMessage":"2c2b34840b8ec9fb735e1b2bed8533fa"}'
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        
      - name: å®‰è£…å¿…è¦å·¥å…·
        run: sudo apt-get -qq install jq && echo "å·¥å…·å®‰è£…å®Œæˆ"
        
      - name: å¤„ç†ç”¨æˆ·ç­¾åˆ°
        id: signin
        run: |
          # è¯»å–JSONé…ç½®æ–‡ä»¶
          config_file="user_config.json"
          
          # å‡†å¤‡çŠ¶æ€æŠ¥å‘Šæ–‡ä»¶
          report_file="token-status.json"
          echo "[]" > $report_file
          
          # å¤„ç†æ¯ä¸ªç”¨æˆ·
          jq -r 'keys[]' $config_file | while read -r user; do
            echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
            echo "ğŸ”„ å¤„ç†ç”¨æˆ·: $user"
            
            # æå–ç”¨æˆ·é…ç½®
            token=$(jq -r ".$user.appToken" $config_file)
            bark_url=$(jq -r ".$user.barkUrl" $config_file)
            
            # æ‰§è¡Œç­¾åˆ°è¯·æ±‚
            response=$(curl -s -L -w "\nHTTP_CODE:%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: $token" \
              -d "$REQUEST_BODY" \
              $API_URL)
              
            http_code=${response##*HTTP_CODE:}
            json_content=${response%HTTP_CODE:*}
            
            # è§£æå“åº”çŠ¶æ€
            status=$(echo $json_content | jq -r '.status?')
            message=$(echo $json_content | jq -r '.message? // empty')
            
            echo "ğŸ“¡ å“åº”çŠ¶æ€: $http_code | APIçŠ¶æ€: ${status:-null} | æ¶ˆæ¯: ${message:-none}"
            
            # è®°å½•çŠ¶æ€ä¿¡æ¯
            timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            status_data="{\"user\":\"$user\",\"timestamp\":\"$timestamp\",\"httpStatus\":$http_code,\"apiStatus\":\"$status\",\"message\":\"$message\"}"
            jq --argjson data "$status_data" '. += [$data]' $report_file > temp.json && mv temp.json $report_file
            
            # æ£€æŸ¥tokenæ˜¯å¦å¤±æ•ˆ
            if [[ "$message" == *"tokenæ ¡éªŒå¤±è´¥"* || $http_code -eq 401 ]]; then
              echo "âŒ æ£€æµ‹åˆ°Tokenå¤±æ•ˆ: $user"
              
              # å‘é€ä¸ªäººé€šçŸ¥
              if [[ -n "$bark_url" && "$bark_url" != "null" ]]; then
                echo "ğŸ“¤ å‘é€Barké€šçŸ¥åˆ°: $user"
                curl -s -X POST \
                  -H 'Content-Type: application/json' \
                  -d "{\"title\":\"ç¢³è´¦æˆ·Tokenå¤±æ•ˆ\",\"body\":\"$user çš„Tokenå·²å¤±æ•ˆï¼Œè¯·åŠæ—¶æ›´æ–°ï¼\"}" \
                  "$bark_url"
              else
                echo "âš ï¸ æœªæ‰¾åˆ°$userçš„Bark URLï¼Œè·³è¿‡é€šçŸ¥"
              fi
            else
              echo "âœ… ç­¾åˆ°æˆåŠŸ: $user"
            fi
            echo ""
          done
        
      - name: æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
        run: |
          echo "================================="
          echo "ğŸ“Š ç”¨æˆ·ç­¾åˆ°æ‰§è¡Œæ‘˜è¦"
          echo "---------------------------------"
          jq -r '.[] | "ç”¨æˆ·: \(.user), çŠ¶æ€: \(if (.message | contains("tokenæ ¡éªŒå¤±è´¥")) or .httpStatus == 401 then "å¤±è´¥" else "æˆåŠŸ" end), æ—¶é—´: \(.timestamp)"' token-status.json
          echo "================================="
        
      - name: ä¿å­˜çŠ¶æ€æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: token-status-report
          path: token-status.json
