name: ç¢³è´¦æˆ·ç­¾åˆ°

on:
  schedule:
    - cron: '1 1 * * *'  # UTCæ—¶é—´1:01ï¼Œå³åŒ—äº¬æ—¶é—´9:01æ‰§è¡Œ
  workflow_dispatch:

jobs:
  carbon-signin:
    runs-on: ubuntu-latest
    env:
      API_URL: https://carbon-account-server.carbonstop.net/task/complete
      REQUEST_BODY: '{"value":1,"sceneCode":"MRCJ0002","signMessage":"2c2b34840b8ec9fb735e1b2bed8533fa"}'
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v3
        
      - name: å®‰è£…jqå·¥å…·
        run: sudo apt-get -qq install jq

      - name: æ‰§è¡Œç”¨æˆ·ç­¾åˆ°ä»»åŠ¡
        id: signin
        run: |
          # è¯»å–JSONé…ç½®æ–‡ä»¶
          config_file="user_config.json"
          users=$(jq -r 'keys[]' $config_file)
          
          # åˆå§‹åŒ–ç»“æœç»Ÿè®¡
          success_count=0
          failed_count=0
          failed_users=""
          
          # å¤„ç†æ¯ä¸ªç”¨æˆ·
          for user in $users; do
            echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
            echo "ğŸ”„ æ­£åœ¨å¤„ç†ç”¨æˆ·: $user"
            
            # æå–ç”¨æˆ·é…ç½®
            token=$(jq -r ".$user.appToken" $config_file)
            bark_url=$(jq -r ".$user.barkUrl" $config_file)
            
            # æ‰§è¡Œç­¾åˆ°è¯·æ±‚
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: $token" \
              -d "$REQUEST_BODY" \
              $API_URL)
            
            # åˆ†ç¦»HTTPçŠ¶æ€ç å’Œå“åº”ä½“
            http_status=$(echo "$response" | grep HTTP_STATUS | cut -d':' -f2)
            json_response=$(echo "$response" | sed '/HTTP_STATUS/d')
            
            # è§£æå“åº”çŠ¶æ€
            status=$(echo $json_response | jq -r '.status')
            message=$(echo $json_response | jq -r '.message // empty')
            
            echo "ğŸ“¡ å“åº”çŠ¶æ€: $http_status | APIçŠ¶æ€: ${status:-null} | æ¶ˆæ¯: ${message:-none}"
            
            # æ£€æŸ¥tokenæ˜¯å¦å¤±æ•ˆ
            if [[ "$message" == *"tokenæ ¡éªŒå¤±è´¥"* || "$http_status" == 401 ]]; then
              echo "âŒ æ£€æµ‹åˆ°Tokenå¤±æ•ˆ: $user"
              failed_count=$((failed_count+1))
              failed_users="$failed_users$user, "
              
              # å‘é€ä¸ªäººé€šçŸ¥
              if [[ -n "$bark_url" ]]; then
                echo "ğŸ“¤ å‘é€Barké€šçŸ¥åˆ°: $user"
                curl -s -X POST \
                  -H 'Content-Type: application/json' \
                  -d "{\"title\":\"ç¢³è´¦æˆ·Tokenå¤±æ•ˆ\",\"body\":\"$user çš„Tokenå·²å¤±æ•ˆï¼Œè¯·åŠæ—¶æ›´æ–°ï¼\"}" \
                  "$bark_url"
              else
                echo "âš ï¸ æœªæ‰¾åˆ°$userçš„Bark URLï¼Œè·³è¿‡é€šçŸ¥"
              fi
              
              # è®°å½•å¤±æ•ˆtokenåˆ°æ–‡ä»¶
              echo "{\"user\":\"$user\",\"timestamp\":\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",\"status\":\"invalid\"}" >> token-status.json
            else
              echo "âœ… ç­¾åˆ°æˆåŠŸ: $user"
              success_count=$((success_count+1))
            fi
            
            # æ·»åŠ ç©ºè¡Œåˆ†éš”æ—¥å¿—
            echo ""
          done
          
          # å‡†å¤‡æ‘˜è¦æŠ¥å‘Š
          summary="ğŸ“Š ç­¾åˆ°æ‘˜è¦ | æˆåŠŸ: $success_count | å¤±è´¥: $failed_count"
          if [ $failed_count -gt 0 ]; then
            summary="$summary | å¤±æ•ˆç”¨æˆ·: ${failed_users%, }"
          fi
          
          echo "::set-output name=summary::$summary"
        
      - name: æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
        run: echo "${{ steps.signin.outputs.summary }}"
        
      - name: ä¸Šä¼ TokençŠ¶æ€è®°å½•
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: token-status-${{ github.run_id }}
          path: token-status.json
