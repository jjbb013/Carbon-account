name: ç¢³è´¦æˆ·ç­¾åˆ°

on:
  schedule:
    - cron: '1 1 * * *'  # UTCæ—¶é—´1:01ï¼Œå³åŒ—äº¬æ—¶é—´9:01æ‰§è¡Œ
  workflow_dispatch:

jobs:
  carbon-signin:
    runs-on: ubuntu-latest
    env:
      API_URL: https://carbon-account-server.carbonstop.net/task/complete
      REQUEST_BODY: '{"value":1,"sceneCode":"MRCJ0002","signMessage":"2c2b34840b8ec9fb735e1b2bed8533fa"}'
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        
      - name: å®‰è£…å¿…è¦å·¥å…·
        run: sudo apt-get -qq install jq && echo "å·¥å…·å®‰è£…å®Œæˆ"
        
      - name: å¤„ç†ç”¨æˆ·ç­¾åˆ°
        id: signin
        run: |
          # å‡†å¤‡çŠ¶æ€æŠ¥å‘Šæ–‡ä»¶
          report_file="token-status.json"
          echo "[]" > $report_file
          
          # å‡†å¤‡åŸå§‹å“åº”æ–‡ä»¶
          raw_dir="raw_responses"
          mkdir -p $raw_dir
          
          # å¤„ç†æ¯ä¸ªç”¨æˆ·
          jq -r 'keys[]' user-configs.json | while read -r user; do
            echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
            echo "ğŸ”„ å¤„ç†ç”¨æˆ·: $user"
            
            # æå–ç”¨æˆ·é…ç½®
            token=$(jq -r ".$user.appToken" user-configs.json)
            bark_url=$(jq -r ".$user.barkUrl" user-configs.json)
            
            # æ£€æŸ¥tokenæ˜¯å¦ä¸ºç©º
            if [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "âš ï¸ è­¦å‘Š: $user çš„appTokenä¸ºç©ºæˆ–æœªè®¾ç½®"
              # è®°å½•çŠ¶æ€ä¿¡æ¯
              timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
              status_data="{\"user\":\"$user\",\"timestamp\":\"$timestamp\",\"status\":\"error\",\"message\":\"appTokenæœªè®¾ç½®\"}"
              jq --argjson data "$status_data" '. += [$data]' $report_file > temp.json && mv temp.json $report_file
              continue
            fi
            
            # åˆ›å»ºåŸå§‹å“åº”æ–‡ä»¶è·¯å¾„
            raw_file="$raw_dir/$user-raw-response.json"
            
            # æ‰§è¡Œç­¾åˆ°è¯·æ±‚å¹¶è®°å½•å®Œæ•´å“åº”
            echo "ğŸ” è¯·æ±‚è¯¦æƒ…:"
            echo "  URL: $API_URL"
            echo "  Token: $token"
            echo "  Body: $REQUEST_BODY"
            
            response=$(curl -s -L -w "\nHTTP_CODE:%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: $token" \
              -d "$REQUEST_BODY" \
              $API_URL | tee "$raw_file")
              
            http_code=${response##*HTTP_CODE:}
            json_content=${response%HTTP_CODE:*}
            
            # ä¿å­˜åŸå§‹å“åº”
            echo "åŸå§‹å“åº”å·²ä¿å­˜è‡³: $raw_file"
            
            # æ‰“å°åŸå§‹å“åº”å†…å®¹
            echo "ğŸ“¡ åŸå§‹å“åº”å†…å®¹:"
            echo "------------------------"
            cat "$raw_file"
            echo "------------------------"
            
            # å…³é”®ä¿®å¤ï¼šæ”¹è¿›å“åº”è§£æé€»è¾‘
            # ä½¿ç”¨ç›´æ¥æ–‡æœ¬æœç´¢ä»£æ›¿JSONè§£æï¼ˆé˜²æ­¢éƒ¨åˆ†å“åº”æ— JSONæ ¼å¼ï¼‰
            token_invalid=false
            if grep -q "tokenæ ¡éªŒå¤±è´¥" "$raw_file" || 
               grep -q "\"code\":600" "$raw_file" || 
               grep -q "\"code\": 600" "$raw_file"; then
              token_invalid=true
            fi
            
            # è¡¥å……JSONè§£æï¼ˆå¦‚æœå¯ç”¨ï¼‰
            code=$(echo $json_content | jq -r '.code? // empty' 2>/dev/null || echo "è§£æå¤±è´¥")
            msg=$(echo $json_content | jq -r '.msg? // empty' 2>/dev/null || echo "è§£æå¤±è´¥")
            
            # è®°å½•çŠ¶æ€ä¿¡æ¯
            timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            status_data="{\"user\":\"$user\",\"timestamp\":\"$timestamp\",\"httpStatus\":$http_code,\"apiCode\":\"$code\",\"apiMsg\":\"$msg\",\"tokenInvalid\":$token_invalid,\"rawFile\":\"$raw_file\"}"
            jq --argjson data "$status_data" '. += [$data]' $report_file > temp.json && mv temp.json $report_file
            
            # æ£€æŸ¥tokenæ˜¯å¦å¤±æ•ˆï¼ˆå…³é”®ä¿®å¤ï¼‰
            if $token_invalid; then
              echo "âŒ æ£€æµ‹åˆ°Tokenå¤±æ•ˆ: $user"
              
              # å‘é€ä¸ªäººé€šçŸ¥
              if [[ -n "$bark_url" && "$bark_url" != "null" ]]; then
                echo "ğŸ“¤ å‘é€Barké€šçŸ¥åˆ°: $user"
                curl -s -X POST \
                  -H 'Content-Type: application/json' \
                  -d "{\"title\":\"ç¢³è´¦æˆ·Tokenå¤±æ•ˆ\",\"body\":\"$user çš„Tokenå·²å¤±æ•ˆï¼Œè¯·åŠæ—¶æ›´æ–°ï¼\"}" \
                  "$bark_url"
              else
                echo "âš ï¸ æœªæ‰¾åˆ°$userçš„Bark URLï¼Œè·³è¿‡é€šçŸ¥"
              fi
            else
              echo "âœ… ç­¾åˆ°æˆåŠŸ: $user"
            fi
            echo ""
          done
        
      - name: æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
        run: |
          echo "================================="
          echo "ğŸ“Š ç”¨æˆ·ç­¾åˆ°æ‰§è¡Œæ‘˜è¦"
          echo "---------------------------------"
          jq -r '.[] | "ç”¨æˆ·: \(.user), çŠ¶æ€: \(if .tokenInvalid then "å¤±è´¥" else "æˆåŠŸ" end), åŸå› : \(.apiMsg), åŸå§‹æ–‡ä»¶: \(.rawFile)"' token-status.json
          echo "================================="
        
      - name: ä¿å­˜çŠ¶æ€æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: carbon-signin-results-${{ github.run_id }}
          path: |
            token-status.json
            raw_responses/
